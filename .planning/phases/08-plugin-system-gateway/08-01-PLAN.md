---
phase: 08-plugin-system-gateway
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - crates/blufio-plugin/Cargo.toml
  - crates/blufio-plugin/src/lib.rs
  - crates/blufio-plugin/src/registry.rs
  - crates/blufio-plugin/src/manifest.rs
  - crates/blufio-plugin/src/catalog.rs
  - crates/blufio-core/src/types.rs
  - crates/blufio-config/src/model.rs
  - crates/blufio/Cargo.toml
  - crates/blufio/src/main.rs
autonomous: true
requirements:
  - PLUG-01
  - PLUG-02
  - PLUG-03

must_haves:
  truths:
    - "PluginRegistry stores PluginEntry records with manifest, status (Enabled/Disabled/NotConfigured), and optional PluginFactory"
    - "PluginManifest parsed from plugin.toml with name, version, adapter_type, capabilities, min_blufio_version, and config_schema"
    - "PluginRegistry::list_all returns all compiled-in plugins with status indicators"
    - "PluginRegistry::get_enabled(adapter_type) returns only enabled plugins matching the requested adapter type"
    - "Built-in catalog contains entries for Telegram, Anthropic, SQLite, ONNX, Prometheus, and Keypair adapters"
    - "blufio plugin list/search/install/remove/update CLI commands parse correctly"
    - "blufio plugin list shows all compiled-in adapters with enabled/disabled/not-configured status"
    - "blufio plugin search queries the hardcoded built-in catalog with no network calls"
    - "blufio plugin install/remove toggles enabled state in blufio.toml via PluginConfig section"
    - "PluginConfig section added to BlufioConfig with plugins map for enable/disable toggle"
  artifacts:
    - crates/blufio-plugin/src/registry.rs
    - crates/blufio-plugin/src/manifest.rs
    - crates/blufio-plugin/src/catalog.rs
    - crates/blufio/src/main.rs
  key_links:
    - "PluginRegistry::register() stores PluginEntry by name with factory and manifest"
    - "PluginRegistry::set_enabled() toggles plugin status, used by install/remove CLI"
    - "catalog::builtin_catalog() returns Vec<PluginManifest> for all 6 default adapters"
    - "blufio plugin list queries PluginRegistry, blufio plugin search queries builtin_catalog"
---

<objective>
Create the blufio-plugin crate with PluginRegistry, plugin manifest parser, built-in adapter catalog, and the `blufio plugin` CLI subcommand for plugin lifecycle management.

Purpose: Establish the plugin framework that transforms Blufio from hardcoded adapter initialization to a registry-based pattern. The PluginRegistry enables serve.rs to discover and initialize adapters dynamically, while the CLI lets users manage which adapters are active. This plan creates the framework; Plan 03 wires it into serve.rs.

Output: New blufio-plugin crate with PluginRegistry, PluginManifest parser, built-in catalog for 6 default adapters. Extended CLI with `blufio plugin list/search/install/remove/update` commands. PluginConfig section in BlufioConfig.
</objective>

<execution_context>
@/Users/suman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/suman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/08-plugin-system-gateway/08-CONTEXT.md
@.planning/phases/08-plugin-system-gateway/08-RESEARCH.md

<interfaces>
<!-- Key types from existing codebase that this plan depends on -->

From crates/blufio-core/src/types.rs:
```rust
#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash, Display, EnumString, Serialize, Deserialize)]
pub enum AdapterType {
    Channel, Provider, Storage, Embedding, Observability, Auth, SkillRuntime,
}

pub struct AuthToken { pub _placeholder: () }
pub struct AuthIdentity { pub _placeholder: () }
pub struct MetricEvent { pub _placeholder: () }
```

From crates/blufio-core/src/traits/adapter.rs:
```rust
#[async_trait]
pub trait PluginAdapter: Send + Sync + 'static {
    fn name(&self) -> &str;
    fn version(&self) -> semver::Version;
    fn adapter_type(&self) -> AdapterType;
    async fn health_check(&self) -> Result<HealthStatus, BlufioError>;
    async fn shutdown(&self) -> Result<(), BlufioError>;
}
```

From crates/blufio-config/src/model.rs (pattern):
```rust
#[derive(Debug, Clone, Default, Deserialize, Serialize)]
#[serde(deny_unknown_fields)]
pub struct BlufioConfig {
    // All sections are optional with defaults
    #[serde(default)]
    pub skill: SkillConfig,
    // ... other sections ...
}
```

From crates/blufio/src/main.rs (CLI pattern):
```rust
#[derive(Subcommand, Debug)]
enum Commands {
    Serve,
    Shell,
    Config { #[command(subcommand)] action: Option<ConfigCommands> },
    Skill { #[command(subcommand)] action: SkillCommands },
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create blufio-plugin crate with PluginRegistry, PluginManifest, and catalog</name>
  <files>Cargo.toml, crates/blufio-plugin/Cargo.toml, crates/blufio-plugin/src/lib.rs, crates/blufio-plugin/src/registry.rs, crates/blufio-plugin/src/manifest.rs, crates/blufio-plugin/src/catalog.rs, crates/blufio-core/src/types.rs</files>
  <action>
1. Add `blufio-plugin` to workspace members in root Cargo.toml.

2. Create `crates/blufio-plugin/Cargo.toml`:
   - Dependencies: blufio-core (path), async-trait (workspace), serde (workspace), serde_json = "1", toml (workspace), semver (workspace), tracing (workspace)
   - Dev-dependencies: tokio = { workspace = true, features = ["test-util", "macros"] }

3. Create `crates/blufio-plugin/src/manifest.rs`:
   - `PluginManifest` struct (separate from SkillManifest -- plugins are adapters, not WASM sandboxes):
     ```rust
     #[derive(Debug, Clone, Serialize, Deserialize)]
     pub struct PluginManifest {
         pub name: String,
         pub version: String,
         pub description: String,
         pub adapter_type: AdapterType,
         pub author: Option<String>,
         pub capabilities: Vec<String>,       // e.g. ["streaming", "editing", "typing"]
         pub min_blufio_version: Option<String>, // e.g. "0.1.0"
         pub config_keys: Vec<String>,         // Required config keys (e.g. ["telegram.bot_token"])
     }
     ```
   - `PluginManifestFile` intermediate TOML deserialization struct:
     ```rust
     #[derive(Debug, Deserialize)]
     struct PluginManifestFile {
         plugin: PluginSection,
     }
     #[derive(Debug, Deserialize)]
     struct PluginSection {
         name: String,
         version: String,
         description: String,
         adapter_type: String,    // Parsed via AdapterType::from_str
         author: Option<String>,
         #[serde(default)]
         capabilities: Vec<String>,
         min_blufio_version: Option<String>,
         #[serde(default)]
         config_keys: Vec<String>,
     }
     ```
   - `pub fn parse_plugin_manifest(toml_content: &str) -> Result<PluginManifest, BlufioError>` -- parses TOML, validates adapter_type via FromStr, returns PluginManifest.
   - Validation: name non-empty, version non-empty, adapter_type must be valid AdapterType variant.

4. Create `crates/blufio-plugin/src/registry.rs`:
   - `PluginStatus` enum:
     ```rust
     #[derive(Debug, Clone, PartialEq, Eq)]
     pub enum PluginStatus {
         Enabled,
         Disabled,
         NotConfigured,  // Compiled in but missing required config
     }
     ```
   - `PluginFactory` trait:
     ```rust
     pub trait PluginFactory: Send + Sync {
         fn adapter_type(&self) -> AdapterType;
         fn create(&self, config: &serde_json::Value) -> Result<Box<dyn PluginAdapter>, BlufioError>;
     }
     ```
   - `PluginEntry` struct:
     ```rust
     pub struct PluginEntry {
         pub manifest: PluginManifest,
         pub status: PluginStatus,
         pub factory: Option<Box<dyn PluginFactory>>,
     }
     ```
   - `PluginRegistry` struct with `HashMap<String, PluginEntry>`:
     - `pub fn new() -> Self`
     - `pub fn register(&mut self, manifest: PluginManifest, factory: Option<Box<dyn PluginFactory>>)` -- stores entry, default status = Enabled
     - `pub fn register_with_status(&mut self, manifest: PluginManifest, factory: Option<Box<dyn PluginFactory>>, status: PluginStatus)`
     - `pub fn get(&self, name: &str) -> Option<&PluginEntry>`
     - `pub fn get_enabled(&self, adapter_type: AdapterType) -> Vec<&PluginEntry>` -- returns only Enabled entries matching type
     - `pub fn list_all(&self) -> Vec<&PluginEntry>` -- returns all entries sorted by name
     - `pub fn set_enabled(&mut self, name: &str, enabled: bool) -> Result<(), BlufioError>` -- toggles status to Enabled/Disabled
     - `pub fn len(&self) -> usize`
     - `pub fn is_empty(&self) -> bool`
   - Note: factory is optional because for the catalog display (plugin search/list), we only need manifests. Factories are attached at startup in serve.rs.

5. Create `crates/blufio-plugin/src/catalog.rs`:
   - `pub fn builtin_catalog() -> Vec<PluginManifest>` -- returns hardcoded manifests for the 6 default adapters:
     - "telegram" (Channel): description "Telegram Bot API channel adapter", capabilities ["text", "images", "documents", "voice", "editing", "typing"], config_keys ["telegram.bot_token"]
     - "anthropic" (Provider): description "Anthropic Claude LLM provider", capabilities ["streaming", "tool_use", "prompt_caching"], config_keys ["anthropic.api_key"]
     - "sqlite" (Storage): description "SQLite WAL-mode persistent storage", capabilities ["sessions", "messages", "queue"], config_keys []
     - "onnx-embedder" (Embedding): description "Local ONNX embedding model", capabilities ["offline", "semantic_search"], config_keys []
     - "prometheus" (Observability): description "Prometheus metrics exporter", capabilities ["counters", "gauges", "histograms"], config_keys []
     - "keypair-auth" (Auth): description "Ed25519 device keypair authentication", capabilities ["bearer_token", "signing"], config_keys []
   - All manifests use version "0.1.0" and min_blufio_version "0.1.0".
   - `pub fn search_catalog(query: &str) -> Vec<PluginManifest>` -- filters builtin_catalog() by name or description containing query (case-insensitive). If query is empty, returns all.

6. Create `crates/blufio-plugin/src/lib.rs`:
   - `pub mod manifest;`
   - `pub mod registry;`
   - `pub mod catalog;`
   - Re-export: `pub use manifest::{PluginManifest, parse_plugin_manifest};`
   - Re-export: `pub use registry::{PluginRegistry, PluginEntry, PluginStatus, PluginFactory};`
   - Re-export: `pub use catalog::{builtin_catalog, search_catalog};`

7. Tests:
   - parse_plugin_manifest with valid TOML produces correct PluginManifest
   - parse_plugin_manifest with invalid adapter_type returns error
   - parse_plugin_manifest with missing name returns error
   - PluginRegistry register + get roundtrip
   - PluginRegistry get_enabled filters by adapter_type and status
   - PluginRegistry set_enabled toggles status
   - PluginRegistry list_all returns all entries
   - builtin_catalog returns exactly 6 entries
   - builtin_catalog covers all 6 AdapterTypes (Channel, Provider, Storage, Embedding, Observability, Auth)
   - search_catalog with "telegram" returns telegram entry
   - search_catalog with empty string returns all
   - search_catalog with "xyz" returns empty
  </action>
  <verify>cd /Users/suman/projects/github/blufio && cargo test -p blufio-plugin && cargo check -p blufio-plugin</verify>
  <done>blufio-plugin crate exists with PluginRegistry, PluginManifest parser, and built-in catalog for 6 default adapters</done>
</task>

<task type="auto">
  <name>Task 2: Add PluginConfig to BlufioConfig and implement blufio plugin CLI commands</name>
  <files>crates/blufio-config/src/model.rs, crates/blufio/Cargo.toml, crates/blufio/src/main.rs</files>
  <action>
1. Add `PluginConfig` to `crates/blufio-config/src/model.rs`:
   ```rust
   /// Plugin system configuration.
   ///
   /// Controls which compiled-in adapters are enabled/disabled.
   /// Each entry in the `plugins` map overrides the default enabled state.
   #[derive(Debug, Clone, Deserialize, Serialize)]
   #[serde(deny_unknown_fields)]
   pub struct PluginConfig {
       /// Per-plugin enable/disable overrides.
       /// Key: plugin name (e.g., "telegram", "anthropic").
       /// Value: true = enabled, false = disabled.
       #[serde(default)]
       pub plugins: HashMap<String, bool>,
   }
   ```
   - Add `use std::collections::HashMap;` import if not present.
   - Add `impl Default for PluginConfig` with empty HashMap.
   - Add `#[serde(default)] pub plugin: PluginConfig` to `BlufioConfig`.

2. Add `blufio-plugin` as dependency to `crates/blufio/Cargo.toml`.

3. Extend CLI in `crates/blufio/src/main.rs`:
   - Add `Plugin` variant to `Commands` enum:
     ```rust
     /// Manage Blufio plugins (compiled-in adapter modules).
     Plugin {
         #[command(subcommand)]
         action: PluginCommands,
     },
     ```
   - Add `PluginCommands` enum:
     ```rust
     #[derive(Subcommand, Debug)]
     enum PluginCommands {
         /// List all compiled-in plugins and their status.
         List,
         /// Search available plugins in the built-in catalog.
         Search {
             /// Search query (matches name or description).
             #[arg(default_value = "")]
             query: String,
         },
         /// Enable a plugin (set enabled in config).
         Install {
             /// Plugin name to enable.
             name: String,
         },
         /// Disable a plugin (set disabled in config).
         Remove {
             /// Plugin name to disable.
             name: String,
         },
         /// Show plugin update information.
         Update,
     }
     ```
   - Add match arm in main():
     ```rust
     Some(Commands::Plugin { action }) => {
         if let Err(e) = handle_plugin_command(&config, action) {
             eprintln!("error: {e}");
             std::process::exit(1);
         }
     }
     ```
   - Implement `handle_plugin_command`:
     - `List`: Build PluginRegistry, register all builtin_catalog entries. For each entry, check config.plugin.plugins map to determine override status. If plugin's config_keys are all present in config (check if telegram.bot_token, anthropic.api_key etc. exist) mark Enabled, else NotConfigured. Print table:
       ```
       NAME             TYPE          STATUS          DESCRIPTION
       -----------------------------------------------------------------------
       telegram         Channel       enabled         Telegram Bot API channel adapter
       anthropic        Provider      not-configured  Anthropic Claude LLM provider
       sqlite           Storage       enabled         SQLite WAL-mode persistent storage
       onnx-embedder    Embedding     enabled         Local ONNX embedding model
       prometheus       Observability disabled        Prometheus metrics exporter
       keypair-auth     Auth          enabled         Ed25519 device keypair authentication
       ```
     - `Search { query }`: Call search_catalog(&query), print matching entries with name, type, description.
     - `Install { name }`: Verify name exists in builtin_catalog. Print: "Plugin '{name}' enabled. Add configuration to blufio.toml if required." Note: actual config file modification is left as manual -- just inform the user what config keys are needed.
     - `Remove { name }`: Verify name exists in builtin_catalog. Print: "Plugin '{name}' disabled."
     - `Update`: Print informational message: "Plugins are compiled into the Blufio binary. Update by rebuilding or downloading a new binary release."

4. Tests:
   - PluginConfig default has empty plugins map
   - PluginConfig deserializes from TOML with plugin overrides
   - CLI parses `blufio plugin list`
   - CLI parses `blufio plugin search telegram`
   - CLI parses `blufio plugin search` (no query = default empty string)
   - CLI parses `blufio plugin install prometheus`
   - CLI parses `blufio plugin remove prometheus`
   - CLI parses `blufio plugin update`
  </action>
  <verify>cd /Users/suman/projects/github/blufio && cargo test -p blufio && cargo test -p blufio-config && cargo check --workspace</verify>
  <done>PluginConfig in BlufioConfig, blufio plugin list/search/install/remove/update CLI commands parse and execute correctly</done>
</task>

</tasks>

<verification>
1. `cargo test -p blufio-plugin` -- all registry, manifest, and catalog tests pass
2. `cargo test -p blufio-config` -- PluginConfig defaults and deny_unknown_fields work
3. `cargo test -p blufio` -- CLI parsing tests for plugin subcommands pass
4. `cargo check --workspace` -- entire workspace compiles with new crate
5. `cargo clippy --workspace` -- no warnings
</verification>

<success_criteria>
- blufio-plugin crate exists with PluginRegistry, PluginManifest, and built-in catalog
- PluginRegistry supports register, get, get_enabled, list_all, set_enabled operations
- Plugin manifests parse from TOML with adapter_type, capabilities, config_keys
- Built-in catalog has 6 entries covering all default adapter types
- blufio plugin list shows all compiled-in plugins with status
- blufio plugin search queries the hardcoded catalog
- blufio plugin install/remove toggles enable/disable state
- blufio plugin update shows informational message
- PluginConfig section in BlufioConfig with per-plugin overrides
- All tests pass, workspace compiles, no clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/08-plugin-system-gateway/08-01-SUMMARY.md`
</output>
