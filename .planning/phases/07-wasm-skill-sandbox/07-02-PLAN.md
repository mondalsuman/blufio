---
phase: 07-wasm-skill-sandbox
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - crates/blufio-skill/Cargo.toml
  - crates/blufio-skill/src/lib.rs
  - crates/blufio-skill/src/manifest.rs
  - crates/blufio-skill/src/sandbox.rs
  - crates/blufio-skill/src/store.rs
  - crates/blufio-skill/src/scaffold.rs
  - crates/blufio-core/src/types.rs
  - crates/blufio-config/src/model.rs
  - crates/blufio-storage/migrations/V5__skill_registry.sql
  - crates/blufio-storage/src/migrations.rs
autonomous: true
requirements:
  - SEC-05
  - SEC-06
  - SKILL-02
  - SKILL-03
  - SKILL-05
  - SKILL-06

must_haves:
  truths:
    - "SkillManifest parses skill.toml with name, version, description, capabilities (network domains, filesystem paths, env vars), and resource limits (fuel, memory_mb, epoch_timeout_secs)"
    - "WasmSkillRuntime creates a fresh wasmtime Store per invocation with fuel limit (default 1B), memory limit (default 16MB), and epoch interruption (default 5s)"
    - "Host functions (log, http_request, read_file, write_file, get_env) are gated by capability manifest — a skill without network permission cannot call http_request"
    - "A WASM skill that exceeds fuel or epoch timeout traps with a descriptive error, not a panic"
    - "SkillStore persists installed skills in SQLite with name, version, wasm_path, manifest, capabilities, verification status, and installed_at"
    - "blufio skill init scaffolds a Rust project with Cargo.toml, src/lib.rs, and skill.toml in a new directory"
    - "SkillConfig section added to BlufioConfig with skills_dir, default resource limits, and max_skills_in_prompt"
    - "V5 migration creates installed_skills table"
  artifacts:
    - crates/blufio-skill/src/manifest.rs
    - crates/blufio-skill/src/sandbox.rs
    - crates/blufio-skill/src/store.rs
    - crates/blufio-skill/src/scaffold.rs
    - crates/blufio-config/src/model.rs
    - crates/blufio-storage/migrations/V5__skill_registry.sql
  key_links:
    - "WasmSkillRuntime uses SkillManifest to configure sandbox capabilities per-skill"
    - "SkillStore uses installed_skills table for persistence of installed skill metadata"
    - "scaffold.rs generates a valid Rust WASM project that compiles to a .wasm file"
---

<objective>
Implement WASM skill sandboxing with wasmtime (fuel, memory, epoch controls), skill manifest parsing, SQLite-backed skill registry, and the `blufio skill init` scaffold generator.

Purpose: Enable third-party skills to execute in isolated WASM sandboxes with enforced resource limits and capability-gated host functions. This is the security foundation — a malicious skill cannot escape the sandbox, exhaust resources, or access capabilities it hasn't declared.

Output: SkillManifest parser for skill.toml. WasmSkillRuntime with per-invocation sandbox isolation. SkillStore for SQLite persistence. Scaffold generator for `blufio skill init`. SkillConfig in BlufioConfig. V5 migration for installed_skills table.
</objective>

<execution_context>
@/Users/suman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/suman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/07-wasm-skill-sandbox/07-CONTEXT.md
@.planning/phases/07-wasm-skill-sandbox/07-RESEARCH.md

<interfaces>
<!-- Key types from existing codebase and Plan 01 outputs -->

From crates/blufio-core/src/types.rs (skill placeholders to replace):
```rust
pub struct SkillManifest { pub _placeholder: () }
pub struct SkillInvocation { pub _placeholder: () }
pub struct SkillResult { pub _placeholder: () }
```

From crates/blufio-core/src/traits/skill.rs:
```rust
#[async_trait]
pub trait SkillRuntimeAdapter: PluginAdapter {
    async fn invoke(&self, invocation: SkillInvocation) -> Result<SkillResult, BlufioError>;
    fn list_skills(&self) -> Vec<SkillManifest>;
}
```

From crates/blufio-config/src/model.rs (existing config sections pattern):
```rust
// All config sections use #[serde(deny_unknown_fields)]
// Follow the same pattern for SkillConfig
```

From crates/blufio-storage/src/migrations.rs (existing migration pattern):
```rust
// Uses refinery for migrations
// V1-V4 already exist
// New migration goes in crates/blufio-storage/migrations/
```

From Plan 01 (blufio-skill crate):
```rust
// Tool trait, ToolOutput, ToolRegistry already defined in blufio-skill/src/tool.rs
// Built-in tools in blufio-skill/src/builtin/
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement SkillManifest parsing and real core types</name>
  <files>crates/blufio-skill/src/manifest.rs, crates/blufio-core/src/types.rs</files>
  <action>
1. Replace placeholder skill types in `crates/blufio-core/src/types.rs`:

   ```rust
   /// Manifest describing a skill's capabilities and requirements.
   #[derive(Debug, Clone, Serialize, Deserialize)]
   pub struct SkillManifest {
       pub name: String,
       pub version: String,
       pub description: String,
       pub author: Option<String>,
       pub capabilities: SkillCapabilities,
       pub resources: SkillResources,
       pub wasm_entry: String,
   }

   /// Capabilities a skill declares it needs.
   #[derive(Debug, Clone, Default, Serialize, Deserialize)]
   pub struct SkillCapabilities {
       pub network: Option<NetworkCapability>,
       pub filesystem: Option<FilesystemCapability>,
       pub env: Vec<String>,
   }

   #[derive(Debug, Clone, Serialize, Deserialize)]
   pub struct NetworkCapability {
       pub domains: Vec<String>,
   }

   #[derive(Debug, Clone, Serialize, Deserialize)]
   pub struct FilesystemCapability {
       pub read: Vec<String>,
       pub write: Vec<String>,
   }

   /// Resource limits for WASM sandbox.
   #[derive(Debug, Clone, Serialize, Deserialize)]
   pub struct SkillResources {
       #[serde(default = "default_fuel")]
       pub fuel: u64,
       #[serde(default = "default_memory_mb")]
       pub memory_mb: u32,
       #[serde(default = "default_epoch_timeout")]
       pub epoch_timeout_secs: u64,
   }
   fn default_fuel() -> u64 { 1_000_000_000 }
   fn default_memory_mb() -> u32 { 16 }
   fn default_epoch_timeout() -> u64 { 5 }

   /// An invocation request for a skill.
   #[derive(Debug, Clone)]
   pub struct SkillInvocation {
       pub skill_name: String,
       pub input: serde_json::Value,
   }

   /// The result of a skill invocation.
   #[derive(Debug, Clone)]
   pub struct SkillResult {
       pub content: String,
       pub is_error: bool,
   }
   ```
   Add `serde_json = "1"` to blufio-core dependencies if not already present.

2. Create `crates/blufio-skill/src/manifest.rs`:
   - `ManifestFile` struct — intermediate deserialization from TOML:
     ```rust
     #[derive(Debug, Deserialize)]
     struct ManifestFile {
         skill: SkillSection,
         #[serde(default)]
         capabilities: CapabilitiesSection,
         #[serde(default)]
         resources: ResourcesSection,
         #[serde(default)]
         wasm: WasmSection,
     }
     ```
   - Each section struct maps the TOML structure from the research (skill.toml format)
   - `pub fn parse_manifest(toml_content: &str) -> Result<SkillManifest, BlufioError>` — parses TOML string into SkillManifest
   - `pub fn load_manifest(path: &Path) -> Result<SkillManifest, BlufioError>` — reads file and parses
   - Validation: name must be non-empty alphanumeric+hyphens, version must be semver-like, wasm_entry defaults to "skill.wasm"

3. Tests:
   - parse_manifest with valid TOML produces correct SkillManifest
   - parse_manifest with missing skill.name returns error
   - Default resources are 1B fuel, 16MB memory, 5s epoch
   - Network capability with domains parsed correctly
   - Filesystem capability with read/write paths parsed correctly
   - Empty capabilities section is valid (no permissions)
  </action>
  <verify>cd /Users/suman/projects/github/blufio && cargo test -p blufio-skill -- manifest && cargo test -p blufio-core -- types</verify>
  <done>SkillManifest parsed from TOML with capabilities and resource limits, placeholder types replaced with real fields</done>
</task>

<task type="auto">
  <name>Task 2: Implement WasmSkillRuntime with sandboxed execution</name>
  <files>Cargo.toml, crates/blufio-skill/Cargo.toml, crates/blufio-skill/src/sandbox.rs, crates/blufio-skill/src/lib.rs</files>
  <action>
1. Add wasmtime dependencies to workspace Cargo.toml:
   ```toml
   wasmtime = { version = "40", features = ["async", "component-model"] }
   wasmtime-wasi = "40"
   ```
   Add to blufio-skill/Cargo.toml: wasmtime (workspace), wasmtime-wasi (workspace), anyhow = "1"

2. Create `crates/blufio-skill/src/sandbox.rs`:

   **SkillState** struct — stored in wasmtime Store:
   ```rust
   struct SkillState {
       manifest: SkillManifest,
       output: Vec<String>,      // Accumulated log output
       wasi: WasiCtx,            // WASI context for filesystem/env
   }
   ```

   **WasmSkillRuntime** struct:
   ```rust
   pub struct WasmSkillRuntime {
       engine: Engine,
       manifests: HashMap<String, SkillManifest>,
       modules: HashMap<String, Module>,  // Pre-compiled modules
   }
   ```

   **Constructor** `fn new() -> Result<Self, BlufioError>`:
   - Create wasmtime Config with:
     - `config.consume_fuel(true)` — enable fuel metering
     - `config.epoch_interruption(true)` — enable epoch timeout
     - `config.async_support(true)` — for async host functions
   - Create Engine from config
   - Store Engine (shared, thread-safe via Arc internally)

   **load_skill** method `fn load_skill(&mut self, manifest: SkillManifest, wasm_bytes: &[u8]) -> Result<(), BlufioError>`:
   - Compile WASM bytes into Module using the shared Engine
   - Store in manifests and modules maps by skill name
   - Compilation happens once, execution creates fresh Store each time

   **invoke** method `async fn invoke(&self, invocation: SkillInvocation) -> Result<SkillResult, BlufioError>`:
   - Look up manifest and module by skill name
   - Build WasiCtx using `build_wasi_ctx(&manifest)`:
     - Only grant preopened_dir for paths in manifest.capabilities.filesystem
     - Set env vars from manifest.capabilities.env (read from actual env)
   - Create fresh Store with SkillState
   - Set fuel: `store.set_fuel(manifest.resources.fuel)`
   - Set epoch deadline: `store.epoch_deadline_trap(manifest.resources.epoch_timeout_secs)`
   - Create Linker and define capability-gated host functions:
     - `log(level: i32, msg_ptr: i32, msg_len: i32)` — always available, appends to output
     - `http_request(...)` — only if manifest.capabilities.network.is_some(), checks domain against allowlist
     - `read_file(...)` — only if manifest.capabilities.filesystem.is_some() with matching read path
     - `write_file(...)` — only if manifest.capabilities.filesystem.is_some() with matching write path
     - `get_env(...)` — only if key is in manifest.capabilities.env
   - Each host function that is NOT permitted returns a trap error "capability not permitted: {capability_name}"
   - Spawn epoch ticker: background tokio task that increments engine epoch every 1 second, aborted when invocation completes
   - Instantiate module and call the exported "run" function with JSON input
   - On success: collect output, return SkillResult
   - On trap (fuel exhausted, epoch timeout): return SkillResult with is_error=true and descriptive message
   - Clean up epoch ticker task

   **Helper**: `fn build_wasi_ctx(manifest: &SkillManifest) -> WasiCtx` — builds WASI context from manifest capabilities.

   **list_skills** method `fn list_skills(&self) -> Vec<SkillManifest>`:
   - Return clones of all loaded manifests

3. Update `crates/blufio-skill/src/lib.rs`:
   - Add `pub mod manifest;`
   - Add `pub mod sandbox;`
   - Re-export: `pub use manifest::{parse_manifest, load_manifest};`
   - Re-export: `pub use sandbox::WasmSkillRuntime;`

4. Tests:
   - WasmSkillRuntime::new() creates successfully
   - Invoke with unknown skill name returns error
   - Capability gating: test that defining a host function without permission is handled (unit test the build_wasi_ctx logic)
   - Epoch ticker spawns and can be aborted (test with a short-lived tokio task)
   - Note: Full WASM execution tests require a compiled .wasm file. Create a minimal test: compile a trivial WAT (WebAssembly Text format) to bytes inline using `wat::parse_str` if the `wat` crate is available, or skip integration test if not feasible. At minimum, test the sandbox configuration logic.
  </action>
  <verify>cd /Users/suman/projects/github/blufio && cargo test -p blufio-skill -- sandbox</verify>
  <done>WasmSkillRuntime creates per-invocation sandboxes with fuel, memory, and epoch controls. Host functions are capability-gated.</done>
</task>

<task type="auto">
  <name>Task 3: Implement SkillStore, SkillConfig, scaffold, and V5 migration</name>
  <files>crates/blufio-skill/src/store.rs, crates/blufio-skill/src/scaffold.rs, crates/blufio-skill/src/lib.rs, crates/blufio-config/src/model.rs, crates/blufio-storage/migrations/V5__skill_registry.sql, crates/blufio-storage/src/migrations.rs</files>
  <action>
1. Create `crates/blufio-storage/migrations/V5__skill_registry.sql`:
   ```sql
   CREATE TABLE IF NOT EXISTS installed_skills (
       name TEXT PRIMARY KEY,
       version TEXT NOT NULL,
       description TEXT NOT NULL,
       author TEXT,
       wasm_path TEXT NOT NULL,
       manifest_toml TEXT NOT NULL,
       capabilities_json TEXT NOT NULL,
       verification_status TEXT NOT NULL DEFAULT 'unverified',
       installed_at TEXT NOT NULL,
       updated_at TEXT NOT NULL
   );
   ```

2. Update `crates/blufio-storage/src/migrations.rs` to include V5 in the refinery migration runner.

3. Add `SkillConfig` to `crates/blufio-config/src/model.rs`:
   ```rust
   #[derive(Debug, Clone, Serialize, Deserialize)]
   #[serde(deny_unknown_fields)]
   pub struct SkillConfig {
       #[serde(default = "default_skills_dir")]
       pub skills_dir: String,      // Default: "~/.blufio/skills"
       #[serde(default = "default_max_fuel")]
       pub default_fuel: u64,       // Default: 1_000_000_000
       #[serde(default = "default_max_memory_mb")]
       pub default_memory_mb: u32,  // Default: 16
       #[serde(default = "default_epoch_timeout")]
       pub default_epoch_timeout_secs: u64,  // Default: 5
       #[serde(default = "default_max_skills_in_prompt")]
       pub max_skills_in_prompt: usize,  // Default: 20
       #[serde(default)]
       pub enabled: bool,           // Default: false
   }
   ```
   Add `#[serde(default)] pub skill: SkillConfig` to `BlufioConfig`.
   Add all default functions.

4. Create `crates/blufio-skill/src/store.rs`:
   - Add `tokio-rusqlite` (workspace) to blufio-skill dependencies
   - `SkillStore` struct holding `Arc<tokio_rusqlite::Connection>`
   - `fn new(conn: Arc<tokio_rusqlite::Connection>) -> Self`
   - `async fn install(&self, manifest: &SkillManifest, wasm_path: &str) -> Result<(), BlufioError>` — INSERT OR REPLACE into installed_skills
   - `async fn remove(&self, name: &str) -> Result<(), BlufioError>` — DELETE from installed_skills
   - `async fn get(&self, name: &str) -> Result<Option<InstalledSkill>, BlufioError>` — SELECT by name
   - `async fn list(&self) -> Result<Vec<InstalledSkill>, BlufioError>` — SELECT all
   - `InstalledSkill` struct: name, version, description, author, wasm_path, manifest_toml, capabilities_json, verification_status, installed_at, updated_at
   - Note: the store opens its own connection to the same SQLite DB, following the pattern from MemoryStore and CostLedger.

5. Create `crates/blufio-skill/src/scaffold.rs`:
   - `pub fn scaffold_skill(name: &str, target_dir: &Path) -> Result<(), BlufioError>`
   - Creates directory structure:
     ```
     {target_dir}/{name}/
     ├── Cargo.toml       # Rust lib crate targeting wasm32-wasip1
     ├── src/
     │   └── lib.rs        # Minimal skill with run() export
     └── skill.toml        # Manifest with empty capabilities
     ```
   - `Cargo.toml` template:
     ```toml
     [package]
     name = "{name}"
     version = "0.1.0"
     edition = "2024"

     [lib]
     crate-type = ["cdylib"]

     [dependencies]
     # Add skill SDK dependencies here
     ```
   - `src/lib.rs` template:
     ```rust
     //! {name} - A Blufio skill
     //!
     //! Build: cargo build --target wasm32-wasip1 --release
     //! Install: blufio skill install target/wasm32-wasip1/release/{name}.wasm

     #[no_mangle]
     pub extern "C" fn run() {
         // Skill implementation here
     }
     ```
   - `skill.toml` template with skill name filled in, empty capabilities, default resources

6. Update `crates/blufio-skill/src/lib.rs`:
   - Add `pub mod store;`
   - Add `pub mod scaffold;`
   - Re-export: `pub use store::SkillStore;`
   - Re-export: `pub use scaffold::scaffold_skill;`

7. Tests:
   - V5 migration creates installed_skills table (use temp DB)
   - SkillStore install + get roundtrip
   - SkillStore install + list returns the skill
   - SkillStore remove + get returns None
   - SkillConfig defaults are correct
   - scaffold_skill creates directory with Cargo.toml, src/lib.rs, skill.toml
   - scaffold_skill uses the provided name in generated files
  </action>
  <verify>cd /Users/suman/projects/github/blufio && cargo test -p blufio-skill -- store && cargo test -p blufio-skill -- scaffold && cargo test -p blufio-config</verify>
  <done>SkillStore persists skills in SQLite, scaffold generates valid Rust WASM projects, SkillConfig added to BlufioConfig, V5 migration ready</done>
</task>

</tasks>

<verification>
1. `cargo test -p blufio-skill` — all manifest, sandbox, store, and scaffold tests pass
2. `cargo test -p blufio-config` — SkillConfig defaults and deny_unknown_fields work
3. `cargo test -p blufio-storage` — V5 migration applies cleanly
4. `cargo check --workspace` — workspace compiles with wasmtime dependencies
</verification>

<success_criteria>
- SkillManifest parses from TOML with capabilities and resource limits
- WasmSkillRuntime creates per-invocation sandboxes with fuel, memory, and epoch controls
- Host functions are capability-gated per manifest
- Fuel exhaustion and epoch timeout produce descriptive errors, not panics
- SkillStore persists installed skills in SQLite
- scaffold_skill creates a valid Rust WASM project scaffold
- SkillConfig added to BlufioConfig with sensible defaults
- V5 migration creates installed_skills table
- All tests pass, workspace compiles
</success_criteria>

<output>
After completion, create `.planning/phases/07-wasm-skill-sandbox/07-02-SUMMARY.md`
</output>
