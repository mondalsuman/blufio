---
phase: 10-multi-agent-final-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/blufio-test-utils/Cargo.toml
  - crates/blufio-test-utils/src/lib.rs
  - crates/blufio-test-utils/src/mock_provider.rs
  - crates/blufio-test-utils/src/mock_channel.rs
  - crates/blufio-test-utils/src/harness.rs
  - Cargo.toml
autonomous: true
requirements: [INFRA-06]

must_haves:
  truths:
    - "MockProvider returns pre-configured responses as ProviderAdapter streams"
    - "MockChannel captures sent messages and injects inbound messages"
    - "TestHarness assembles a complete agent stack with mocks and temp SQLite"
    - "TestHarness::send_message() sends a message through the full agent pipeline and returns the response"
    - "Test utilities are available to all workspace crates via dev-dependencies"
  artifacts:
    - path: "crates/blufio-test-utils/src/mock_provider.rs"
      provides: "MockProvider implementing ProviderAdapter"
      contains: "impl ProviderAdapter for MockProvider"
    - path: "crates/blufio-test-utils/src/mock_channel.rs"
      provides: "MockChannel implementing ChannelAdapter"
      contains: "impl ChannelAdapter for MockChannel"
    - path: "crates/blufio-test-utils/src/harness.rs"
      provides: "TestHarness builder for E2E test environment"
      contains: "struct TestHarness"
  key_links:
    - from: "crates/blufio-test-utils/src/harness.rs"
      to: "crates/blufio-agent/src/lib.rs"
      via: "TestHarness creates AgentLoop with mock adapters"
      pattern: "AgentLoop::new"
    - from: "crates/blufio-test-utils/src/mock_provider.rs"
      to: "crates/blufio-core/src/traits.rs"
      via: "MockProvider implements ProviderAdapter trait"
      pattern: "ProviderAdapter"
---

<objective>
Create a reusable test utility crate (blufio-test-utils) with MockProvider, MockChannel, and TestHarness builder pattern for end-to-end integration testing.

Purpose: Provides the testing infrastructure needed for E2E smoke tests in Plan 10-03. Mock adapters enable fast, deterministic, CI-runnable tests without external services.

Output: New blufio-test-utils workspace crate with mock ProviderAdapter, mock ChannelAdapter, and TestHarness builder.
</objective>

<execution_context>
@/Users/suman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/suman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

<interfaces>
<!-- Key traits that mock implementations must satisfy -->

From crates/blufio-core/src/traits.rs:
```rust
#[async_trait]
pub trait ProviderAdapter {
    async fn complete(&self, request: ProviderRequest) -> Result<ProviderResponse, BlufioError>;
    async fn stream(&self, request: ProviderRequest) -> Result<Pin<Box<dyn Stream<Item = Result<ProviderStreamChunk, BlufioError>> + Send>>, BlufioError>;
}

#[async_trait]
pub trait ChannelAdapter {
    async fn connect(&mut self) -> Result<(), BlufioError>;
    async fn receive(&self) -> Result<InboundMessage, BlufioError>;
    async fn send(&self, message: OutboundMessage) -> Result<MessageId, BlufioError>;
    async fn send_typing(&self, chat_id: &str) -> Result<(), BlufioError>;
    async fn edit_message(&self, chat_id: &str, message_id: &str, text: &str, parse_mode: Option<&str>) -> Result<(), BlufioError>;
    fn capabilities(&self) -> ChannelCapabilities;
}

#[async_trait]
pub trait StorageAdapter {
    async fn create_session(&self, session: &Session) -> Result<(), BlufioError>;
    async fn get_session(&self, id: &str) -> Result<Option<Session>, BlufioError>;
    async fn update_session_state(&self, id: &str, state: &str) -> Result<(), BlufioError>;
    async fn list_sessions(&self, state: Option<&str>) -> Result<Vec<Session>, BlufioError>;
    async fn insert_message(&self, message: &Message) -> Result<(), BlufioError>;
    async fn get_messages(&self, session_id: &str, limit: Option<usize>) -> Result<Vec<Message>, BlufioError>;
    async fn close(&self) -> Result<(), BlufioError>;
}
```

From crates/blufio-core/src/types.rs:
```rust
pub struct ProviderRequest { pub model, system_prompt, system_blocks, messages, max_tokens, stream, tools }
pub struct ProviderStreamChunk { pub event_type, text, usage, tool_use, stop_reason, error }
pub enum StreamEventType { MessageStart, ContentBlockStart, ContentBlockDelta, ContentBlockStop, MessageDelta, MessageStop, Ping, Error }
pub struct InboundMessage { pub id, channel, sender_id, content, metadata }
pub struct OutboundMessage { pub session_id, channel, content, reply_to, parse_mode, metadata }
pub struct ChannelCapabilities { pub supports_edit: bool, pub supports_typing: bool, pub supports_media: bool }
pub struct TokenUsage { pub input_tokens, output_tokens, cache_read_tokens, cache_creation_tokens }
```

From crates/blufio-agent/src/lib.rs:
```rust
pub struct AgentLoop { /* ... */ }
impl AgentLoop {
    pub async fn new(channel, provider, storage, context_engine, cost_ledger, budget_tracker, memory_provider, memory_extractor, router, heartbeat_runner, tool_registry, config) -> Result<Self, BlufioError>;
    pub async fn run(&mut self, cancel: CancellationToken) -> Result<(), BlufioError>;
}
```
</interfaces>
</context>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: Create blufio-test-utils crate with MockProvider and MockChannel</name>
  <files>crates/blufio-test-utils/Cargo.toml, crates/blufio-test-utils/src/lib.rs, crates/blufio-test-utils/src/mock_provider.rs, crates/blufio-test-utils/src/mock_channel.rs, Cargo.toml</files>
  <behavior>
    - Test: MockProvider with queued responses returns them in order via stream()
    - Test: MockProvider with no queued responses returns default "mock response" text
    - Test: MockProvider stream produces correct SSE event sequence (MessageStart -> ContentBlockDelta -> MessageDelta -> MessageStop)
    - Test: MockChannel::receive() returns injected messages from the send queue
    - Test: MockChannel::send() captures outbound messages retrievable via sent_messages()
    - Test: MockChannel::capabilities() returns non-edit, non-typing capabilities by default
    - Test: MockProvider::complete() returns a ProviderResponse with the queued text
  </behavior>
  <action>
Create the new crate directory `crates/blufio-test-utils/`.

Create `Cargo.toml`:
```toml
[package]
name = "blufio-test-utils"
version.workspace = true
edition.workspace = true
license.workspace = true
repository.workspace = true
authors.workspace = true
publish = false
description = "Test utilities for Blufio integration tests"

[dependencies]
blufio-core = { path = "../blufio-core" }
async-trait.workspace = true
futures.workspace = true
tokio = { workspace = true, features = ["sync", "time"] }
serde_json = "1"
uuid.workspace = true
chrono.workspace = true
tracing.workspace = true
```

The workspace Cargo.toml already includes this crate via `members = ["crates/*"]`.

Create `mock_provider.rs`:
- `MockProvider` struct with `Arc<tokio::sync::Mutex<VecDeque<String>>>` for queued responses
- Implements `ProviderAdapter` trait
- `stream()` pops from queue, returns a stream that yields: MessageStart (with model), ContentBlockDelta (with text), MessageDelta (with usage + stop_reason "end_turn"), MessageStop
- `complete()` pops from queue, returns ProviderResponse with text and usage
- Constructor: `MockProvider::new()` and `MockProvider::with_responses(responses: Vec<String>)`
- `MockProvider::add_response(&self, text: String)` for adding responses after construction
- Default response is "mock response" when queue is empty

Create `mock_channel.rs`:
- `MockChannel` struct with two queues: `inbound: Arc<tokio::sync::Mutex<VecDeque<InboundMessage>>>` and `sent: Arc<tokio::sync::Mutex<Vec<OutboundMessage>>>`
- Implements `ChannelAdapter` trait
- `connect()` always succeeds
- `receive()` pops from inbound queue; if empty, waits using a tokio::sync::Notify
- `send()` captures to sent list, returns MessageId
- `send_typing()` is a no-op
- `edit_message()` is a no-op
- `capabilities()` returns all-false ChannelCapabilities
- Helper methods: `inject_message(&self, msg: InboundMessage)`, `sent_messages(&self) -> Vec<OutboundMessage>`

Create `lib.rs` that re-exports both modules.

Write unit tests in each module verifying the behavior items.
  </action>
  <verify>
    <automated>cargo test -p blufio-test-utils -- --nocapture</automated>
  </verify>
  <done>MockProvider queues and serves responses as ProviderAdapter streams, MockChannel injects/captures messages, both implement their respective traits correctly, all tests pass.</done>
</task>

<task type="auto" tdd="true">
  <name>Task 2: Create TestHarness builder for complete E2E test environments</name>
  <files>crates/blufio-test-utils/src/harness.rs, crates/blufio-test-utils/src/lib.rs, crates/blufio-test-utils/Cargo.toml</files>
  <behavior>
    - Test: TestHarness::builder().build() creates a working test environment with defaults
    - Test: TestHarness with_mock_provider(responses) uses those responses
    - Test: send_message("hello") triggers the full pipeline and returns the mock response text
    - Test: TestHarness creates a temp SQLite database that is cleaned up after drop
    - Test: TestHarness with_budget(amount) configures budget tracker with daily limit
    - Test: TestHarness provides access to cost_ledger for assertion
  </behavior>
  <action>
Add dependencies to blufio-test-utils Cargo.toml:
```toml
blufio-agent = { path = "../blufio-agent" }
blufio-config = { path = "../blufio-config" }
blufio-context = { path = "../blufio-context" }
blufio-cost = { path = "../blufio-cost" }
blufio-router = { path = "../blufio-router" }
blufio-skill = { path = "../blufio-skill" }
blufio-storage = { path = "../blufio-storage" }
tokio-rusqlite.workspace = true
tokio-util = { workspace = true }
tempfile = "3"
```

Create `harness.rs` with a TestHarness builder:

```rust
pub struct TestHarnessBuilder {
    responses: Vec<String>,
    daily_budget_usd: Option<f64>,
}

pub struct TestHarness {
    pub mock_provider: Arc<MockProvider>,
    pub mock_channel: Arc<MockChannel>,
    pub storage: Arc<dyn StorageAdapter + Send + Sync>,
    pub cost_ledger: Arc<CostLedger>,
    pub config: BlufioConfig,
    _temp_dir: tempfile::TempDir,  // Kept alive for cleanup on drop
}

impl TestHarness {
    pub fn builder() -> TestHarnessBuilder;
}
```

The builder:
1. Creates a tempfile::TempDir for the SQLite database
2. Initializes SqliteStorage with the temp DB path
3. Creates CostLedger pointing to the same temp DB
4. Creates BudgetTracker with optional budget
5. Creates a ContextEngine with default config
6. Creates ModelRouter with defaults (routing disabled for tests)
7. Creates an empty ToolRegistry
8. Creates MockProvider with queued responses
9. Creates MockChannel
10. Does NOT create an AgentLoop (tests drive the pipeline directly through the harness)

Instead of wrapping AgentLoop (which runs an infinite loop), TestHarness provides lower-level access:
- `send_message(text: &str) -> Result<String, BlufioError>`: Creates an InboundMessage, injects it into MockChannel, creates a SessionActor, calls handle_message + consume_stream + persist_response, returns the full response text.
- `provider()`, `channel()`, `storage()`, `cost_ledger()`: Accessors for assertions.

This approach avoids the complexity of running AgentLoop in a background task and managing cancellation tokens in tests.

Add `pub mod harness;` to lib.rs and re-export TestHarness.

Write integration tests that verify the harness works end-to-end.

IMPORTANT: The harness test that calls send_message should verify:
1. MockProvider's queued response appears in the output
2. The message is persisted in storage (user message + assistant response)
3. Cost is recorded in the cost_ledger
  </action>
  <verify>
    <automated>cargo test -p blufio-test-utils -- --nocapture</automated>
  </verify>
  <done>TestHarness builder creates a complete test environment, send_message drives the full pipeline with mocks, temp DB is cleaned up on drop, budget/cost tracking works in test context, all tests pass.</done>
</task>

</tasks>

<verification>
- `cargo test -p blufio-test-utils` -- all mock adapter and harness tests pass
- `cargo build --workspace` -- blufio-test-utils compiles without errors
- `cargo clippy -p blufio-test-utils` -- no warnings
</verification>

<success_criteria>
- MockProvider implements ProviderAdapter with queued response delivery
- MockChannel implements ChannelAdapter with message injection and capture
- TestHarness builder creates complete test environments with temp SQLite
- send_message() drives the full pipeline (storage, context, provider, cost) with mocks
- Crate is available as a workspace member for any crate's dev-dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/10-multi-agent-final-integration/10-02-SUMMARY.md`
</output>
