---
phase: 10-multi-agent-final-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/blufio-auth-keypair/src/keypair.rs
  - crates/blufio-auth-keypair/src/lib.rs
  - crates/blufio-auth-keypair/src/message.rs
  - crates/blufio-auth-keypair/Cargo.toml
  - crates/blufio-config/src/model.rs
  - crates/blufio-config/src/validation.rs
autonomous: true
requirements: [SEC-07]

must_haves:
  truths:
    - "DeviceKeypair can sign arbitrary byte payloads and produce Ed25519 signatures"
    - "DeviceKeypair can verify signatures against its public key using strict mode"
    - "AgentMessage can be serialized to canonical bytes, signed, and verified round-trip"
    - "SignedAgentMessage rejects tampered payloads with a Security error"
    - "BlufioConfig accepts [[agents]] TOML array with name, system_prompt, model, allowed_skills fields"
  artifacts:
    - path: "crates/blufio-auth-keypair/src/keypair.rs"
      provides: "sign() and verify_strict() methods on DeviceKeypair"
      contains: "fn sign"
    - path: "crates/blufio-auth-keypair/src/message.rs"
      provides: "AgentMessage, AgentMessageType, SignedAgentMessage types"
      contains: "struct AgentMessage"
    - path: "crates/blufio-config/src/model.rs"
      provides: "AgentSpecConfig struct and agents field on BlufioConfig"
      contains: "struct AgentSpecConfig"
  key_links:
    - from: "crates/blufio-auth-keypair/src/message.rs"
      to: "crates/blufio-auth-keypair/src/keypair.rs"
      via: "sign_message() and verify_message() use DeviceKeypair::sign/verify_strict"
      pattern: "keypair\\.sign|keypair\\.verify_strict"
---

<objective>
Extend DeviceKeypair with Ed25519 sign/verify methods, create AgentMessage types for signed inter-agent communication, and add agent specialization config to BlufioConfig.

Purpose: Establishes the cryptographic foundation (SEC-07) and configuration model for multi-agent delegation. This plan creates the types and signing infrastructure that Plan 10-03 wires into the delegation system.

Output: Extended blufio-auth-keypair with signing, AgentMessage/SignedAgentMessage types, AgentSpecConfig in blufio-config.
</objective>

<execution_context>
@/Users/suman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/suman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From crates/blufio-auth-keypair/src/keypair.rs:
```rust
pub struct DeviceKeypair {
    signing_key: SigningKey,
    verifying_key: VerifyingKey,
}

impl DeviceKeypair {
    pub fn generate() -> Self;
    pub fn from_bytes(private_bytes: &[u8; 32]) -> Result<Self, BlufioError>;
    pub fn private_bytes(&self) -> [u8; 32];
    pub fn public_bytes(&self) -> [u8; 32];
    pub fn public_hex(&self) -> String;
    pub fn verify_token(&self, token: &str) -> bool;
}
```

From crates/blufio-auth-keypair/Cargo.toml:
```toml
[dependencies]
ed25519-dalek = { workspace = true }  # 2.1 with rand_core
```

From crates/blufio-core/src/error.rs (BlufioError variants):
```rust
pub enum BlufioError {
    Security(String),
    // ... other variants
}
```

From crates/blufio-config/src/model.rs (BlufioConfig):
```rust
pub struct BlufioConfig {
    pub agent: AgentConfig,
    pub telegram: TelegramConfig,
    pub anthropic: AnthropicConfig,
    // ... (all existing fields)
    pub daemon: DaemonConfig,
}
// All structs use #[serde(deny_unknown_fields)]
```
</interfaces>
</context>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: Extend DeviceKeypair with sign() and verify_strict() methods</name>
  <files>crates/blufio-auth-keypair/src/keypair.rs, crates/blufio-auth-keypair/Cargo.toml</files>
  <behavior>
    - Test: sign() produces a 64-byte Ed25519 Signature for arbitrary bytes
    - Test: verify_strict() succeeds for correctly signed bytes
    - Test: verify_strict() returns BlufioError::Security for tampered bytes
    - Test: verify_strict() returns BlufioError::Security for wrong keypair
    - Test: sign+verify round-trip succeeds for empty bytes, small payload, large payload (10KB)
  </behavior>
  <action>
Add `Signer` and `Verifier` trait imports from `ed25519_dalek` to keypair.rs. Add `ed25519_dalek::Signature` to the public API.

Add two methods to `DeviceKeypair`:

```rust
use ed25519_dalek::{Signature, Signer, Verifier};

/// Sign arbitrary bytes with this keypair's private key.
pub fn sign(&self, message: &[u8]) -> Signature {
    self.signing_key.sign(message)
}

/// Verify a signature against this keypair's public key (strict mode).
/// Rejects weak public keys per ed25519-dalek security recommendations.
pub fn verify_strict(&self, message: &[u8], signature: &Signature) -> Result<(), BlufioError> {
    self.verifying_key.verify_strict(message, signature).map_err(|e| {
        BlufioError::Security(format!("Ed25519 signature verification failed: {e}"))
    })
}
```

Re-export `ed25519_dalek::Signature` from the crate's lib.rs so downstream crates can reference it without adding ed25519-dalek directly.

In Cargo.toml, ensure `serde` dependency exists (already in workspace deps) since we'll need it for AgentMessage serialization in Task 2.

Write comprehensive tests covering the behavior items above.
  </action>
  <verify>
    <automated>cargo test -p blufio-auth-keypair -- --nocapture</automated>
  </verify>
  <done>DeviceKeypair::sign() returns Ed25519 Signature, DeviceKeypair::verify_strict() validates signatures and rejects tampering with BlufioError::Security, all tests pass.</done>
</task>

<task type="auto" tdd="true">
  <name>Task 2: Create AgentMessage and SignedAgentMessage types</name>
  <files>crates/blufio-auth-keypair/src/message.rs, crates/blufio-auth-keypair/src/lib.rs</files>
  <behavior>
    - Test: AgentMessage serializes to deterministic canonical JSON bytes
    - Test: SignedAgentMessage::new() signs the canonical bytes of the AgentMessage
    - Test: SignedAgentMessage::verify() succeeds with correct sender keypair
    - Test: SignedAgentMessage::verify() fails when message content is tampered after signing
    - Test: SignedAgentMessage::verify() fails when verified against wrong agent's keypair
    - Test: AgentMessageType enum has Request and Response variants
    - Test: AgentMessage with all fields populated round-trips through serde_json
  </behavior>
  <action>
Create `crates/blufio-auth-keypair/src/message.rs` with:

```rust
use chrono::Utc;
use serde::{Deserialize, Serialize};
use uuid::Uuid;

use crate::keypair::DeviceKeypair;
use blufio_core::BlufioError;
use ed25519_dalek::Signature;

/// Type of inter-agent message.
#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq)]
#[serde(rename_all = "snake_case")]
pub enum AgentMessageType {
    Request,
    Response,
}

/// An inter-agent message payload.
/// All fields are included in the signed payload for integrity.
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct AgentMessage {
    pub id: String,
    pub sender: String,
    pub recipient: String,
    pub message_type: AgentMessageType,
    pub task: String,
    pub content: String,
    pub timestamp: String,
}

impl AgentMessage {
    /// Create a new request message.
    pub fn new_request(sender: &str, recipient: &str, task: &str, context: &str) -> Self {
        Self {
            id: Uuid::new_v4().to_string(),
            sender: sender.to_string(),
            recipient: recipient.to_string(),
            message_type: AgentMessageType::Request,
            task: task.to_string(),
            content: context.to_string(),
            timestamp: Utc::now().to_rfc3339(),
        }
    }

    /// Create a response to a request.
    pub fn new_response(request: &AgentMessage, sender: &str, content: &str) -> Self {
        Self {
            id: Uuid::new_v4().to_string(),
            sender: sender.to_string(),
            recipient: request.sender.clone(),
            message_type: AgentMessageType::Response,
            task: request.task.clone(),
            content: content.to_string(),
            timestamp: Utc::now().to_rfc3339(),
        }
    }

    /// Serialize to canonical JSON bytes for signing.
    pub fn canonical_bytes(&self) -> Vec<u8> {
        serde_json::to_vec(self).expect("AgentMessage is always JSON-serializable")
    }
}

/// A signed inter-agent message with Ed25519 signature.
#[derive(Debug, Clone)]
pub struct SignedAgentMessage {
    pub message: AgentMessage,
    pub signature: Signature,
    /// The exact bytes that were signed (canonical serialization).
    pub signed_bytes: Vec<u8>,
}

impl SignedAgentMessage {
    /// Create a new signed message using the sender's keypair.
    pub fn new(message: AgentMessage, keypair: &DeviceKeypair) -> Self {
        let signed_bytes = message.canonical_bytes();
        let signature = keypair.sign(&signed_bytes);
        Self { message, signature, signed_bytes }
    }

    /// Verify this message was signed by the claimed sender.
    /// Uses strict verification (rejects weak keys).
    pub fn verify(&self, sender_keypair: &DeviceKeypair) -> Result<(), BlufioError> {
        sender_keypair.verify_strict(&self.signed_bytes, &self.signature)
    }
}
```

Add `pub mod message;` to lib.rs. Re-export `AgentMessage`, `AgentMessageType`, `SignedAgentMessage` from lib.rs.

Add `uuid` and `chrono` workspace dependencies to blufio-auth-keypair/Cargo.toml (they're already workspace deps).

Write tests per the behavior items.
  </action>
  <verify>
    <automated>cargo test -p blufio-auth-keypair -- --nocapture</automated>
  </verify>
  <done>AgentMessage serializes deterministically, SignedAgentMessage signs and verifies correctly, tampering detection works, wrong-keypair rejection works, all tests pass.</done>
</task>

<task type="auto" tdd="true">
  <name>Task 3: Add AgentSpecConfig to BlufioConfig for [[agents]] TOML section</name>
  <files>crates/blufio-config/src/model.rs, crates/blufio-config/src/validation.rs</files>
  <behavior>
    - Test: BlufioConfig with empty agents array (default) deserializes correctly
    - Test: BlufioConfig with [[agents]] entries deserializes name, system_prompt, model, allowed_skills
    - Test: deny_unknown_fields rejects unknown fields in [[agents]] entries
    - Test: agents default to empty Vec when not specified in TOML
    - Test: delegation_timeout_secs defaults to 60 when not specified
  </behavior>
  <action>
Add `AgentSpecConfig` struct and `DelegationConfig` struct to model.rs:

```rust
/// Configuration for a specialist agent used in multi-agent delegation.
#[derive(Debug, Clone, Deserialize, Serialize)]
#[serde(deny_unknown_fields)]
pub struct AgentSpecConfig {
    /// Unique name for this specialist agent.
    pub name: String,
    /// System prompt that defines the specialist's behavior.
    pub system_prompt: String,
    /// LLM model to use for this specialist (e.g., "claude-haiku-4-5-20250901").
    #[serde(default = "default_agent_model")]
    pub model: String,
    /// List of tool names this specialist is allowed to use.
    #[serde(default)]
    pub allowed_skills: Vec<String>,
}

fn default_agent_model() -> String {
    "claude-sonnet-4-20250514".to_string()
}

/// Multi-agent delegation configuration.
#[derive(Debug, Clone, Deserialize, Serialize)]
#[serde(deny_unknown_fields)]
pub struct DelegationConfig {
    /// Enable multi-agent delegation.
    #[serde(default)]
    pub enabled: bool,
    /// Timeout in seconds for specialist responses.
    #[serde(default = "default_delegation_timeout")]
    pub timeout_secs: u64,
}

impl Default for DelegationConfig {
    fn default() -> Self {
        Self {
            enabled: false,
            timeout_secs: default_delegation_timeout(),
        }
    }
}

fn default_delegation_timeout() -> u64 {
    60
}
```

Add to BlufioConfig:
```rust
/// Specialist agent definitions for multi-agent delegation.
#[serde(default)]
pub agents: Vec<AgentSpecConfig>,

/// Multi-agent delegation settings.
#[serde(default)]
pub delegation: DelegationConfig,
```

Add validation in validation.rs to check for duplicate agent names in the agents array.

Write tests per the behavior items. Use `toml::from_str::<BlufioConfig>(...)` for deserialization tests.
  </action>
  <verify>
    <automated>cargo test -p blufio-config -- --nocapture</automated>
  </verify>
  <done>BlufioConfig supports [[agents]] TOML array with AgentSpecConfig fields, DelegationConfig with timeout, deny_unknown_fields works on agent entries, validation catches duplicate agent names, all tests pass.</done>
</task>

</tasks>

<verification>
- `cargo test -p blufio-auth-keypair` -- all sign/verify and AgentMessage tests pass
- `cargo test -p blufio-config` -- all agent config deserialization tests pass
- `cargo build --workspace` -- no compile errors across the workspace
- `cargo clippy --workspace` -- no warnings
</verification>

<success_criteria>
- DeviceKeypair has sign() and verify_strict() methods with ed25519-dalek
- AgentMessage/SignedAgentMessage provide signed inter-agent communication types
- BlufioConfig accepts [[agents]] TOML sections for specialist agent definitions
- All new code has unit tests covering happy path and error cases
- SEC-07 cryptographic foundation is in place for Plan 10-03 to wire into delegation
</success_criteria>

<output>
After completion, create `.planning/phases/10-multi-agent-final-integration/10-01-SUMMARY.md`
</output>
