---
phase: 12-verify-unverified-phases
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/09-production-hardening/09-VERIFICATION.md
autonomous: true
requirements:
  - CORE-04
  - CORE-06
  - CORE-07
  - CORE-08
  - COST-04
  - CLI-02
  - CLI-03
  - CLI-04
  - CLI-07
  - CLI-08

must_haves:
  truths:
    - "09-VERIFICATION.md exists with top-level verdict and SC-1 through SC-5 verification"
    - "Each SC traces to specific files, functions, and code evidence"
    - "Requirements coverage table maps all 10 Phase 9 requirement IDs"
    - "Three-tier status (PASS/PARTIAL/FAIL) assigned to each success criterion"
    - "Memory bound requirements (CORE-07, CORE-08) note that they are architectural targets verified by configuration, not runtime measurement"
  artifacts:
    - path: ".planning/phases/09-production-hardening/09-VERIFICATION.md"
      provides: "Phase 9 formal verification document"
      contains: "Phase Status:"
---

<objective>
Create VERIFICATION.md for Phase 9 (Production Hardening) by tracing all 10 requirements through the codebase and verifying each of the 5 success criteria from ROADMAP.md.

Purpose: Phase 9 has been complete since 2026-03-01 but lacks formal verification. This document confirms production hardening requirements (systemd, memory bounds, Prometheus, CLI diagnostics, operations) are satisfied. Phase 9 already has all SUMMARYs (09-01, 09-02, 09-03) so no retroactive summaries needed.

Output: `.planning/phases/09-production-hardening/09-VERIFICATION.md`
</objective>

<execution_context>
@/Users/suman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/suman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/09-production-hardening/09-01-PLAN.md
@.planning/phases/09-production-hardening/09-02-PLAN.md
@.planning/phases/09-production-hardening/09-03-PLAN.md
@.planning/phases/09-production-hardening/09-01-SUMMARY.md
@.planning/phases/09-production-hardening/09-02-SUMMARY.md
@.planning/phases/09-production-hardening/09-03-SUMMARY.md
@.planning/phases/11-fix-integration-bugs/11-VERIFICATION.md

<interfaces>
Phase 9 Success Criteria (from ROADMAP.md):
  SC-1: The agent runs as a systemd service with health checks and auto-restart on crash -- systemctl status blufio shows healthy
  SC-2: Idle memory stays within 50-80MB and memory under load stays within 100-200MB with no unbounded growth over 72+ hours
  SC-3: Prometheus metrics endpoint exports token usage, latency percentiles, error rates, and memory usage -- scrapeable by standard Prometheus setup
  SC-4: blufio status shows running agent state, active sessions, memory usage, and cost summary; blufio doctor runs full diagnostics; blufio config get/set/set-secret/validate manages configuration
  SC-5: Device keypair authentication is required (no optional auth mode), backup/restore and log rotation scripts work, and shell lifecycle hooks execute correctly

Phase 9 Requirements: CORE-04, CORE-06, CORE-07, CORE-08, COST-04, CLI-02, CLI-03, CLI-04, CLI-07, CLI-08

Key source files to trace:
  - crates/blufio-prometheus/src/ (Prometheus metrics)
  - crates/blufio-gateway/src/ (metrics endpoint)
  - crates/blufio/src/main.rs (CLI commands: status, doctor, config)
  - crates/blufio/src/serve.rs (daemon startup, memory monitoring)
  - crates/blufio-config/src/ (DaemonConfig, memory config)
  - deployment/ (systemd unit file, logrotate, scripts)
  - crates/blufio-auth-keypair/src/ (device keypair auth)
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deep code trace for systemd, memory, and Prometheus (SC-1, SC-2, SC-3)</name>
  <files>
    .planning/phases/09-production-hardening/09-VERIFICATION.md
  </files>
  <action>
Read and trace through the Phase 9 source files:

**SC-1 (systemd service):**
- Look for systemd unit file in `deployment/` directory (e.g., `blufio.service`)
- Check for health check mechanism (could be HTTP /health endpoint or systemd-notify)
- Verify auto-restart configuration (Restart=on-failure or similar)
- Read DaemonConfig in blufio-config if it exists
- Trace CORE-04 and CLI-07

**SC-2 (Memory bounds):**
- Read memory monitoring code -- look for MemoryMonitor or similar in blufio or blufio-config
- Check jemalloc allocator configuration (should be in the binary crate)
- Look for bounded LRU caches, bounded channels (backpressure)
- Verify memory config values (50-80MB idle, 100-200MB load targets)
- Note: These are architectural targets -- verify the mechanisms are in place, not runtime measurements
- Trace CORE-06, CORE-07, CORE-08

**SC-3 (Prometheus metrics):**
- Read `crates/blufio-prometheus/src/` -- verify Prometheus exporter
- Check for metric types: token usage, latency percentiles, error rates, memory usage
- Read gateway endpoint registration -- verify /metrics route
- Trace COST-04

Do NOT write the verification file yet -- continue to Task 2.
  </action>
  <verify>
    <automated>cd /Users/suman/projects/github/blufio && ls crates/blufio-prometheus/src/*.rs deployment/* 2>/dev/null | head -20</automated>
  </verify>
  <done>
    - Evidence collected for SC-1 (systemd), SC-2 (memory bounds), SC-3 (Prometheus)
    - Requirements CORE-04, CORE-06, CORE-07, CORE-08, COST-04, CLI-07 traced
  </done>
</task>

<task type="auto">
  <name>Task 2: Deep code trace for CLI diagnostics and operations (SC-4, SC-5) and write 09-VERIFICATION.md</name>
  <files>
    .planning/phases/09-production-hardening/09-VERIFICATION.md
  </files>
  <action>
**SC-4 (CLI diagnostics):**
- Read `crates/blufio/src/main.rs` -- find status, doctor, config subcommands
- Verify `blufio status` shows: running state, active sessions, memory usage, cost summary
- Verify `blufio doctor` runs diagnostics: LLM connectivity, DB integrity, channel status, memory usage
- Verify `blufio config` has get/set/set-secret/validate subcommands
- Trace CLI-02, CLI-03, CLI-04

**SC-5 (Auth + operations):**
- Read `crates/blufio-auth-keypair/src/` -- verify device keypair authentication
- Check that auth is required (no optional mode) -- look for enforcement in serve.rs or config
- Look for backup/restore scripts in `deployment/` or CLI commands
- Look for log rotation config (logrotate.d file or similar)
- Look for shell lifecycle hooks
- Trace CLI-08

Run `cargo check --workspace` and `cargo test --workspace` for build verification.

**Write 09-VERIFICATION.md** following Phase 11 format with:
- Top-level verdict
- SC-1 through SC-5 with code evidence
- Build verification section
- Requirements coverage table (CORE-04, CORE-06, CORE-07, CORE-08, COST-04, CLI-02, CLI-03, CLI-04, CLI-07, CLI-08)
- Note that memory bounds (CORE-07, CORE-08) are architectural targets verified by mechanism, not runtime measurement
  </action>
  <verify>
    <automated>cd /Users/suman/projects/github/blufio && test -f .planning/phases/09-production-hardening/09-VERIFICATION.md && grep -c "SC-" .planning/phases/09-production-hardening/09-VERIFICATION.md</automated>
  </verify>
  <done>
    - 09-VERIFICATION.md created with all 5 SC verified
    - Top-level verdict present
    - Each SC has specific code evidence
    - Build verification section with results
    - Requirements coverage table maps all 10 requirement IDs
    - Memory bound requirements noted as architectural targets
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. `09-VERIFICATION.md` exists and follows Phase 11 format
2. All 5 success criteria have evidence blocks
3. All 10 requirement IDs appear in the requirements coverage table

```bash
cd /Users/suman/projects/github/blufio && test -f .planning/phases/09-production-hardening/09-VERIFICATION.md && grep "Phase Status:" .planning/phases/09-production-hardening/09-VERIFICATION.md
```
</verification>

<success_criteria>
- 09-VERIFICATION.md follows Phase 11 format exactly
- All 5 SC verified with code evidence
- All 10 requirements mapped in coverage table
- Build verification section current
- Memory requirements noted as architectural targets
- Top-level verdict at top for quick scanning
</success_criteria>

<output>
After completion, create `.planning/phases/12-verify-unverified-phases/12-05-SUMMARY.md`
</output>
