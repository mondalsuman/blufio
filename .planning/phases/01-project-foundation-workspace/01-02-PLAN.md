---
phase: 01-project-foundation-workspace
plan: 02
type: tdd
wave: 2
depends_on:
  - "01-01"
files_modified:
  - crates/blufio-config/src/lib.rs
  - crates/blufio-config/src/model.rs
  - crates/blufio-config/src/loader.rs
  - crates/blufio-config/src/validation.rs
  - crates/blufio-config/src/diagnostic.rs
  - crates/blufio/src/main.rs
autonomous: true
requirements:
  - CLI-06

must_haves:
  truths:
    - "TOML config with an unknown key is rejected at startup with a clear error message naming the bad key"
    - "Typo in a config key produces a 'did you mean X?' suggestion using fuzzy matching"
    - "Config error messages include the source file path and valid key listings"
    - "`deny_unknown_fields` is active on ALL config section structs"
    - "Environment variables with BLUFIO_ prefix override TOML values (e.g., BLUFIO_AGENT_NAME overrides agent.name)"
    - "Config lookup follows XDG hierarchy: ./blufio.toml > ~/.config/blufio/blufio.toml > /etc/blufio/blufio.toml"
    - "Missing config files are silently skipped (no error for absent optional files)"
    - "Config sections match user decision: [agent], [telegram], [anthropic], [storage], [security], [cost]"
  artifacts:
    - path: "crates/blufio-config/src/model.rs"
      provides: "Config structs with deny_unknown_fields and serde defaults"
      contains: "deny_unknown_fields"
    - path: "crates/blufio-config/src/loader.rs"
      provides: "Figment-based config assembly with XDG lookup and env var overrides"
      contains: "Figment::new()"
    - path: "crates/blufio-config/src/diagnostic.rs"
      provides: "Figment-to-miette error bridge with fuzzy match suggestions"
      contains: "jaro_winkler"
    - path: "crates/blufio-config/src/validation.rs"
      provides: "Post-deserialization validation for config values"
      contains: "fn validate"
  key_links:
    - from: "crates/blufio-config/src/loader.rs"
      to: "crates/blufio-config/src/model.rs"
      via: "Figment::extract() deserializes into BlufioConfig"
      pattern: "extract::<BlufioConfig>"
    - from: "crates/blufio-config/src/diagnostic.rs"
      to: "crates/blufio-config/src/loader.rs"
      via: "Converts figment::Error into miette-rendered ConfigError"
      pattern: "figment_to_config_errors"
    - from: "crates/blufio-config/src/loader.rs"
      to: "figment::providers::Env"
      via: "Env::map() for explicit section-to-dot mapping (NOT split)"
      pattern: "Env::prefixed.*map"
    - from: "crates/blufio/src/main.rs"
      to: "crates/blufio-config/src/loader.rs"
      via: "Config loading at startup before agent initialization"
      pattern: "load_config"
---

<objective>
Implement the TOML configuration system with strict validation, actionable error messages, and environment variable overrides -- catching typos at startup with Elm-style diagnostic rendering.

Purpose: The config system is the user's primary interface for customizing Blufio. Config errors must feel like Elm compiler errors: helpful, not cryptic. `deny_unknown_fields` catches typos immediately, and fuzzy matching suggests corrections. This is the "kill shot" user experience that differentiates from competitors.

Output: A complete config system with TOML parsing, XDG file hierarchy, environment variable overrides, deny_unknown_fields validation, miette-rendered error diagnostics with typo suggestions, and integration into the binary crate's startup.
</objective>

<execution_context>
@/Users/suman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/suman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-project-foundation-workspace/01-RESEARCH.md
@.planning/phases/01-project-foundation-workspace/01-CONTEXT.md
@.planning/phases/01-project-foundation-workspace/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: Create config model structs and figment loader with XDG hierarchy and env var overrides</name>
  <files>
    crates/blufio-config/src/model.rs,
    crates/blufio-config/src/loader.rs,
    crates/blufio-config/src/lib.rs
  </files>
  <behavior>
    - Test: Valid TOML with all known fields deserializes successfully into BlufioConfig
    - Test: TOML with an unknown field in [agent] section produces `Kind::UnknownField` error
    - Test: TOML with an unknown field in [telegram] section produces `Kind::UnknownField` error
    - Test: Missing optional sections (e.g., no [telegram]) use defaults without error
    - Test: Environment variable `BLUFIO_AGENT_NAME=test` overrides `agent.name` in TOML
    - Test: Environment variable `BLUFIO_TELEGRAM_BOT_TOKEN=xyz` overrides `telegram.bot_token` (NOT telegram.bot.token -- see research Pitfall 5)
    - Test: Serialized defaults provide sensible values for all required fields
    - Test: Missing config files are silently skipped (Figment's `Toml::file()` behavior)
    - Test: Config sections match user decision: agent, telegram, anthropic, storage, security, cost
  </behavior>
  <action>
    **crates/blufio-config/src/model.rs:**
    Define config structs with `#[serde(deny_unknown_fields)]` on EVERY struct. Flat section layout (per user decision -- no nesting beyond one level, no `#[serde(flatten)]` anywhere):

    ```rust
    #[derive(Debug, Clone, Deserialize, Serialize)]
    #[serde(deny_unknown_fields)]
    pub struct BlufioConfig {
        #[serde(default)]
        pub agent: AgentConfig,
        #[serde(default)]
        pub telegram: TelegramConfig,
        #[serde(default)]
        pub anthropic: AnthropicConfig,
        #[serde(default)]
        pub storage: StorageConfig,
        #[serde(default)]
        pub security: SecurityConfig,
        #[serde(default)]
        pub cost: CostConfig,
    }
    ```

    Each section struct (all with `deny_unknown_fields` + `Default`):
    - `AgentConfig`: `name: String` (default "blufio"), `max_sessions: usize` (default 10), `log_level: String` (default "info")
    - `TelegramConfig`: `bot_token: Option<String>`, `allowed_users: Vec<String>` (default empty)
    - `AnthropicConfig`: `api_key: Option<String>`, `default_model: String` (default "claude-sonnet-4-20250514")
    - `StorageConfig`: `database_path: String` (default "blufio.db"), `wal_mode: bool` (default true)
    - `SecurityConfig`: `bind_address: String` (default "127.0.0.1"), `require_tls: bool` (default true)
    - `CostConfig`: `daily_budget_usd: Option<f64>`, `monthly_budget_usd: Option<f64>`, `track_tokens: bool` (default true)

    Implement `Default` for `BlufioConfig` and all section structs with sensible defaults.

    **crates/blufio-config/src/loader.rs:**
    Implement `load_config()` using Figment layered merging:

    ```rust
    pub fn load_config() -> Result<BlufioConfig, figment::Error> {
        Figment::new()
            .merge(Serialized::defaults(BlufioConfig::default()))
            .merge(Toml::file("/etc/blufio/blufio.toml"))
            .merge(Toml::file(
                dirs::config_dir()
                    .map(|d| d.join("blufio/blufio.toml"))
                    .unwrap_or_default()
            ))
            .merge(Toml::file("blufio.toml"))
            .merge(env_provider())
            .extract()
    }
    ```

    **CRITICAL: Use `Env::map()` NOT `Env::split("_")`** (see research Pitfall 5 -- split is fundamentally broken for keys with underscores like `bot_token`):

    ```rust
    fn env_provider() -> Env {
        Env::prefixed("BLUFIO_").map(|key| {
            // key is lowercased with prefix stripped: "telegram_bot_token"
            key.as_str()
                .replacen("agent_", "agent.", 1)
                .replacen("telegram_", "telegram.", 1)
                .replacen("anthropic_", "anthropic.", 1)
                .replacen("storage_", "storage.", 1)
                .replacen("security_", "security.", 1)
                .replacen("cost_", "cost.", 1)
                .into()
        })
    }
    ```

    Also provide `load_config_from_path(path: &Path)` for testing that loads from a specific file only (no XDG lookup).

    **crates/blufio-config/src/lib.rs:**
    Update to export `model`, `loader` modules publicly. Re-export `BlufioConfig` and `load_config` at crate root for ergonomic use.

    **CRITICAL RULES:**
    - `#[serde(deny_unknown_fields)]` on ALL structs, no exceptions
    - NO `#[serde(flatten)]` anywhere (incompatible with deny_unknown_fields, research Pitfall 1)
    - Use `Env::map()` NOT `Env::split("_")` for environment variable mapping
    - All .rs files MUST have SPDX header
    - All config structs must derive `Serialize` (needed for Serialized::defaults)
  </action>
  <verify>
    <automated>cd /Users/suman/projects/github/blufio && cargo test -p blufio-config -- --nocapture 2>&1</automated>
  </verify>
  <done>
    - All config model structs have `deny_unknown_fields` attribute
    - Valid TOML deserializes into BlufioConfig with correct values
    - Unknown fields produce figment `Kind::UnknownField` errors
    - Environment variables with BLUFIO_ prefix correctly override TOML values
    - `BLUFIO_TELEGRAM_BOT_TOKEN` maps to `telegram.bot_token` (not `telegram.bot.token`)
    - Missing config files are silently skipped
    - Config sections are: agent, telegram, anthropic, storage, security, cost
  </done>
</task>

<task type="auto" tdd="true">
  <name>Task 2: Implement figment-to-miette error bridge with fuzzy match suggestions and wire config into binary startup</name>
  <files>
    crates/blufio-config/src/diagnostic.rs,
    crates/blufio-config/src/validation.rs,
    crates/blufio-config/src/lib.rs,
    crates/blufio/src/main.rs
  </files>
  <behavior>
    - Test: Unknown key "naem" in [agent] section produces suggestion "did you mean `name`?"
    - Test: Unknown key "bot_tken" in [telegram] produces suggestion "did you mean `bot_token`?"
    - Test: Unknown key "zzzzzz" with no close match does NOT produce a suggestion (threshold too low)
    - Test: Error output includes the source file path
    - Test: Error output includes the list of valid keys for the section
    - Test: Invalid type (string where number expected) produces clear type mismatch message
    - Test: Missing required field produces "missing key" message with helpful hint
    - Test: ConfigError types implement miette::Diagnostic (render to ANSI-formatted output)
    - Test: `blufio` binary starts and loads config without error when no config file exists (defaults are valid)
  </behavior>
  <action>
    **crates/blufio-config/src/diagnostic.rs:**
    Implement the Figment-to-miette error bridge (~150 lines, see research Deep Dive):

    1. Define `ConfigError` enum using both `thiserror` and `miette::Diagnostic` derive:
       - `UnknownKey { key, suggestion, valid_keys, span: SourceSpan, src: NamedSource<String> }` with `#[diagnostic(code(blufio::config::unknown_key), help("did you mean `{suggestion}`? Valid keys: {valid_keys}"))]`
       - `InvalidType { key, detail, expected, span: SourceSpan, src: NamedSource<String> }` with `#[diagnostic(code(blufio::config::invalid_type))]`
       - `MissingKey { key }` with `#[diagnostic(code(blufio::config::missing_key), help("add `{key} = <value>` to your blufio.toml"))]`
       - `Other(Box<dyn std::error::Error + Send + Sync>)` as catch-all

    2. Implement `figment_to_config_errors(err: figment::Error, toml_sources: &[(String, String)]) -> Vec<ConfigError>`:
       - Iterate through `err` (figment::Error implements IntoIterator)
       - Match on `Kind::UnknownField(field, expected)`:
         - Run `suggest_key(field, expected)` for fuzzy match
         - Find byte offset in TOML source via `find_key_offset()`
         - Construct `ConfigError::UnknownKey` with miette `SourceSpan` and `NamedSource`
       - Match on `Kind::MissingField(field)`: construct `ConfigError::MissingKey`
       - Match on `Kind::InvalidType(actual, expected)`: construct `ConfigError::InvalidType`
       - Default: wrap in `ConfigError::Other`

    3. Implement `suggest_key(unknown: &str, valid_keys: &[&str]) -> Option<String>`:
       - Use `strsim::jaro_winkler()` for fuzzy matching
       - Threshold: 0.75 (not 0.8 -- lower threshold catches more typos like `max_sesions`)
       - Return best match above threshold, or None

    4. Implement `find_key_offset(content: &str, path: &[String], field: &str) -> Option<usize>`:
       - If path has a section (e.g., ["agent", "naem"]): find `[agent]` header, then search for field after it
       - If top-level: search from start of content
       - Return byte offset for miette SourceSpan construction

    5. Implement `find_source(err: &figment::Error, sources: &[(String, String)]) -> Option<(&str, &String)>`:
       - Extract file path from `err.metadata.source`
       - Find matching source content in the provided sources list

    **crates/blufio-config/src/validation.rs:**
    Implement post-deserialization validation:
    - `pub fn validate_config(config: &BlufioConfig) -> Result<(), Vec<ConfigError>>`
    - Validate: bind_address is valid IP or hostname, database_path is not empty, budget values are non-negative if set
    - Return collected validation errors (not fail-fast)

    **crates/blufio-config/src/lib.rs:**
    - Add `diagnostic` and `validation` modules to exports
    - Add a high-level `pub fn load_and_validate() -> Result<BlufioConfig, Vec<ConfigError>>` that:
      1. Calls `loader::load_config()`
      2. On success: runs `validation::validate_config()`
      3. On figment error: reads TOML source files, calls `diagnostic::figment_to_config_errors()`
      4. Returns either valid config or diagnostic errors

    **crates/blufio/src/main.rs:**
    Update the binary entry point to:
    - Call `blufio_config::load_and_validate()` at startup
    - On error: render each `ConfigError` using miette's `GraphicalReportHandler` for Elm-style ANSI output, then `std::process::exit(1)`
    - On success: print config loaded message (for now) and continue to CLI dispatch
    - Ensure the binary starts cleanly with no config file (defaults are valid)

    **CRITICAL RULES:**
    - Use `strsim::jaro_winkler` NOT `strsim::levenshtein` (see research: Jaro-Winkler is better for short config key names)
    - Threshold 0.75 for fuzzy matching (see research: lower threshold catches more useful suggestions)
    - Figment `Kind::UnknownField` already carries the valid field list -- do NOT manually enumerate fields
    - All .rs files MUST have SPDX header
    - Error rendering must use miette for ANSI/Unicode diagnostic display
  </action>
  <verify>
    <automated>cd /Users/suman/projects/github/blufio && cargo test -p blufio-config -- --nocapture 2>&1 && cargo test -p blufio -- --nocapture 2>&1 && cargo build --release -p blufio 2>&1</automated>
  </verify>
  <done>
    - Unknown config key "naem" produces suggestion "did you mean `name`?"
    - Unknown config key "bot_tken" produces suggestion "did you mean `bot_token`?"
    - Distant typo "zzzzzz" produces no suggestion (below threshold)
    - Error messages include source file path and valid key listings
    - ConfigError implements miette::Diagnostic for rich ANSI rendering
    - `blufio` binary starts cleanly with no config file (uses defaults)
    - `blufio` binary exits with code 1 and renders diagnostic errors on invalid config
    - All tests pass: `cargo test --workspace`
  </done>
</task>

</tasks>

<verification>
Run the following commands to verify the complete config system:

```bash
# 1. All tests pass
cargo test --workspace

# 2. Full build including release
cargo build --release -p blufio

# 3. Binary starts with no config (defaults should work)
cargo run -p blufio -- --help

# 4. Create invalid config and verify error rendering
cat > /tmp/blufio-test-bad.toml << 'EOF'
[agent]
naem = "test"
EOF
# Should produce: unknown key `naem`, did you mean `name`?

# 5. Create valid config and verify loading
cat > /tmp/blufio-test-good.toml << 'EOF'
[agent]
name = "test-agent"
max_sessions = 5
EOF
# Should load without errors

# 6. Verify deny_unknown_fields is active on all sections
cargo test -p blufio-config -- deny_unknown --nocapture

# 7. Verify env var overrides work
BLUFIO_AGENT_NAME=envtest cargo test -p blufio-config -- env_override --nocapture
```
</verification>

<success_criteria>
1. TOML config with `deny_unknown_fields` rejects invalid config keys at startup with clear error messages
2. Typo suggestions via Jaro-Winkler fuzzy matching appear in error output for close matches
3. Error messages include source file path, line context, and valid key listings
4. Environment variable overrides with BLUFIO_ prefix work correctly (BLUFIO_TELEGRAM_BOT_TOKEN maps to telegram.bot_token)
5. XDG lookup hierarchy works: ./blufio.toml > ~/.config/blufio/blufio.toml > /etc/blufio/blufio.toml
6. Binary starts cleanly with no config file (sensible defaults)
7. Binary renders miette diagnostic errors on invalid config and exits with code 1
8. All config sections match user decision: agent, telegram, anthropic, storage, security, cost
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-foundation-workspace/01-02-SUMMARY.md`
</output>
