---
phase: 11-fix-integration-bugs
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/blufio-agent/src/lib.rs
autonomous: true
requirements: [LLM-05]

must_haves:
  truths:
    - Tool follow-up requests use the model selected by ModelRouter, not default_model
    - When routing is disabled, follow-ups correctly use default_model
    - Debug-level log emitted when routed model is used for tool follow-ups
  artifacts:
    - crates/blufio-agent/src/lib.rs with routing-aware tool follow-up model selection
  key_links:
    - Follow-up ProviderRequest.model reads from SessionActor.last_routing_decision
    - Fallback to default_model when no routing decision exists
---

<objective>
Fix P3: Model router bypass in tool follow-up requests.

Purpose: When the model router classifies a message as complex (routing to Opus), the initial LLM call uses Opus correctly. But tool follow-up calls hardcode `self.config.anthropic.default_model` (typically Sonnet), causing model inconsistency mid-conversation. A complex analysis that triggers tool calls silently downgrades to Sonnet for the tool follow-up, degrading response quality.

Output: Tool follow-up requests reuse the model from the initial routing decision for that session.
</objective>

<execution_context>
@/Users/suman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/suman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

<interfaces>
<!-- Key types the executor needs. -->

From crates/blufio-agent/src/session.rs (routing decision storage):
```rust
// SessionActor stores the last routing decision (line ~275):
self.last_routing_decision = Some(decision);

// Public accessor:
pub fn last_routing_decision(&self) -> Option<&RoutingDecision> {
    self.last_routing_decision.as_ref()
}
```

From crates/blufio-router/src/router.rs (RoutingDecision):
```rust
pub struct RoutingDecision {
    pub intended_model: String,
    pub actual_model: String,   // ← This is the model to use
    pub max_tokens: u32,
    pub downgraded: bool,
    pub tier: ComplexityTier,
    pub reason: String,
}
```

From crates/blufio-agent/src/lib.rs (bug location at line 431-432):
```rust
let follow_up_request = ProviderRequest {
    model: self.config.anthropic.default_model.clone(),  // ← BUG: always default
    system_prompt: None,
    system_blocks: None,
    messages,
    max_tokens: self.config.anthropic.max_tokens,
    stream: true,
    tools: tool_defs,
};
```

From crates/blufio-agent/src/lib.rs (session access pattern around line 418):
```rust
let actor = self.sessions.get(&session_id).ok_or_else(|| {
    BlufioError::Internal(format!("session actor not found for {session_id}"))
})?;
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Use routed model for tool follow-up requests</name>
  <files>crates/blufio-agent/src/lib.rs</files>
  <action>
Fix the tool follow-up ProviderRequest construction at `lib.rs` line ~431-432. Replace the hardcoded `self.config.anthropic.default_model` with the model from the session's last routing decision.

**Replace the follow-up request construction** (around lines 431-439):

Before (current code):
```rust
let follow_up_request = ProviderRequest {
    model: self.config.anthropic.default_model.clone(),
    system_prompt: None,
    system_blocks: None,
    messages,
    max_tokens: self.config.anthropic.max_tokens,
    stream: true,
    tools: tool_defs,
};
```

After (fixed code):
```rust
// P3 fix: Use the model from the initial routing decision for this session,
// not the hardcoded default_model. This ensures tool follow-ups use the same
// model tier that was selected for the initial request (e.g., Opus for complex queries).
let (follow_up_model, follow_up_max_tokens) = {
    let actor = self.sessions.get(&session_id).ok_or_else(|| {
        BlufioError::Internal(format!("session actor not found for {session_id}"))
    })?;
    match actor.last_routing_decision() {
        Some(decision) => {
            debug!(
                session_id = %session_id,
                model = %decision.actual_model,
                "tool follow-up using routed model"
            );
            (decision.actual_model.clone(), decision.max_tokens)
        }
        None => {
            debug!(
                session_id = %session_id,
                model = %self.config.anthropic.default_model,
                "tool follow-up using default model (no routing decision)"
            );
            (self.config.anthropic.default_model.clone(), self.config.anthropic.max_tokens)
        }
    }
};

let follow_up_request = ProviderRequest {
    model: follow_up_model,
    system_prompt: None,
    system_blocks: None,
    messages,
    max_tokens: follow_up_max_tokens,
    stream: true,
    tools: tool_defs,
};
```

NOTE: There is already an `actor` variable accessed at line 418 for tool_defs. The new code accesses the session a second time. This is fine -- `self.sessions.get()` is a HashMap lookup (O(1)) and the borrow is dropped before the next mutable access. If the existing `actor` variable at line 418 is still in scope, reuse it instead of creating a new one. Check the scope:

```bash
grep -n "let actor" crates/blufio-agent/src/lib.rs | head -10
```

If the existing `actor` from line 418 is still in scope at line 431, simply use it:
```rust
let (follow_up_model, follow_up_max_tokens) = match actor.last_routing_decision() {
    // ... same logic as above
};
```

Also verify that `debug!` macro is imported (it should be via `use tracing::{debug, ...}`).
  </action>
  <verify>
    <automated>cargo check -p blufio-agent 2>&1 | tail -5</automated>
  </verify>
  <done>Tool follow-up requests use the routed model from the session's last routing decision. When routing is disabled (no decision stored), falls back to default_model. Debug log emitted in both cases. `cargo check` passes.</done>
</task>

</tasks>

<verification>
- `cargo check --workspace` passes
- Follow-up ProviderRequest uses `decision.actual_model` when routing decision exists
- Follow-up ProviderRequest falls back to `self.config.anthropic.default_model` when no decision exists
- Debug-level log emitted for both paths showing which model is used
- No change to initial request model selection (session.rs is untouched)
</verification>

<success_criteria>
- Tool follow-up requests use the model selected by ModelRouter, not default_model
- When routing is disabled, follow-ups correctly use default_model (no regression)
- Debug-level logging confirms model selection for follow-ups
- `cargo check --workspace` passes
</success_criteria>

<output>
After completion, create `.planning/phases/11-fix-integration-bugs/11-04-SUMMARY.md`
</output>
